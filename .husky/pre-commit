#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$')

if [ -z "$STAGED_FILES" ]; then
  echo "‚úÖ No TypeScript/JavaScript files to check"
  exit 0
fi

echo "üìù Files to validate:"
echo "$STAGED_FILES" | head -10

# Run ESLint with fix
echo ""
echo "üîé Running ESLint..."
npx eslint --fix $STAGED_FILES 2>&1
ESLINT_EXIT=$?

if [ $ESLINT_EXIT -ne 0 ]; then
  echo "‚ùå ESLint found issues"
  git add $STAGED_FILES 2>/dev/null || true
else
  echo "‚úÖ ESLint passed"
fi

# Run TypeScript compiler
echo ""
echo "üì¶ Running TypeScript compiler..."
npx tsc --noEmit 2>&1
TSCRIPT_EXIT=$?

if [ $TSCRIPT_EXIT -ne 0 ]; then
  echo "‚ùå TypeScript compilation failed"
fi

# Re-add any auto-fixed files
git add $STAGED_FILES 2>/dev/null || true

# Final status
echo ""
if [ $ESLINT_EXIT -eq 0 ] && [ $TSCRIPT_EXIT -eq 0 ]; then
  echo "‚úÖ All checks passed! Commit allowed."
  exit 0
else
  echo "‚ùå Pre-commit checks failed. Please fix errors and try again."
  exit 1
fi
